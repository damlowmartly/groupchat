<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CipherChain - Command Center</title>
  <link rel="icon" href="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/i/6873254d-c380-460a-a41f-fbf0a7cce980/d6rv32a-5af9d818-6d89-4057-8c48-f4a68f1bb7fa.png" type="image/png" />
  <style>* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Courier New', monospace;
  background: #0a0e27;
  color: #00ff41;
  overflow: hidden;
  height: 100vh;
}

#matrix-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  opacity: 0.1;
}

#namePrompt {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 14, 39, 0.98);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  animation: fadeIn 0.5s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.terminal-header {
  text-align: center;
  margin-bottom: 30px;
}

.terminal-header h1 {
  font-size: 2.5em;
  color: #00ff41;
  text-shadow: 0 0 10px #00ff41, 0 0 20px #00ff41;
  margin-bottom: 10px;
  animation: glow 2s ease-in-out infinite;
}

@keyframes glow {
  0%, 100% { text-shadow: 0 0 10px #00ff41, 0 0 20px #00ff41; }
  50% { text-shadow: 0 0 20px #00ff41, 0 0 30px #00ff41, 0 0 40px #00ff41; }
}

.terminal-header p {
  color: #0ff;
  font-size: 0.9em;
  letter-spacing: 2px;
}

.access-panel {
  background: rgba(0, 255, 65, 0.05);
  border: 2px solid #00ff41;
  padding: 40px;
  border-radius: 10px;
  box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
  min-width: 400px;
}

.input-group {
  margin-bottom: 20px;
}

.input-group label {
  display: block;
  margin-bottom: 8px;
  color: #0ff;
  font-size: 0.9em;
  text-transform: uppercase;
  letter-spacing: 1px;
}

input[type="text"], input[type="password"], textarea, select {
  width: 100%;
  padding: 12px;
  background: rgba(0, 0, 0, 0.7);
  border: 1px solid #00ff41;
  color: #00ff41;
  font-family: 'Courier New', monospace;
  font-size: 1em;
  border-radius: 5px;
  transition: all 0.3s;
}

input[type="text"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
  outline: none;
  border-color: #0ff;
  box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
}

textarea {
  min-height: 80px;
  resize: vertical;
}

button {
  width: 100%;
  padding: 12px;
  background: linear-gradient(45deg, #00ff41, #0ff);
  border: none;
  color: #0a0e27;
  font-family: 'Courier New', monospace;
  font-size: 1em;
  font-weight: bold;
  cursor: pointer;
  border-radius: 5px;
  text-transform: uppercase;
  letter-spacing: 2px;
  transition: all 0.3s;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(0, 255, 65, 0.5);
}

#chatInterface {
  display: none;
  position: relative;
  z-index: 1;
  height: 100vh;
  flex-direction: column;
}

.chat-header {
  background: rgba(0, 255, 65, 0.1);
  border-bottom: 2px solid #00ff41;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.chat-header h2 {
  color: #00ff41;
  font-size: 1.2em;
  text-shadow: 0 0 10px #00ff41;
}

.status-bar {
  display: flex;
  gap: 15px;
  align-items: center;
  font-size: 0.85em;
  flex-wrap: wrap;
}

.status-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #00ff41;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.user-info {
  color: #0ff;
}

#messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
}

#messages::-webkit-scrollbar {
  width: 8px;
}

#messages::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.3);
}

#messages::-webkit-scrollbar-thumb {
  background: #00ff41;
  border-radius: 4px;
}

.message {
  margin-bottom: 15px;
  padding: 12px 15px;
  background: rgba(0, 255, 65, 0.05);
  border-left: 3px solid #00ff41;
  border-radius: 5px;
  animation: slideIn 0.3s;
  max-width: 80%;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.message.me {
  align-self: flex-end;
  border-left: none;
  border-right: 3px solid #0ff;
  background: rgba(0, 255, 255, 0.05);
}

.message-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 0.85em;
}

.sender-name {
  color: #0ff;
  font-weight: bold;
}

.message.me .sender-name {
  color: #00ff41;
}

.timestamp {
  color: #666;
  font-size: 0.9em;
}

.message-content {
  color: #fff;
  word-wrap: break-word;
}

.message img, .message video {
  max-width: 100%;
  margin-top: 10px;
  border-radius: 5px;
  border: 1px solid #00ff41;
  cursor: pointer;
}

.input-area {
  background: rgba(0, 0, 0, 0.5);
  border-top: 2px solid #00ff41;
  padding: 15px 20px;
}

.input-controls {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
}

.input-controls input[type="text"] {
  flex: 1;
}

.input-controls button {
  width: auto;
  padding: 10px 20px;
}

.media-controls {
  display: flex;
  gap: 10px;
  justify-content: space-between;
}

.media-button {
  flex: 1;
  padding: 8px;
  font-size: 0.85em;
  background: rgba(0, 255, 65, 0.1);
  border: 1px solid #00ff41;
  color: #00ff41;
}

.media-button:hover {
  background: rgba(0, 255, 65, 0.2);
}

input[type="file"] {
  display: none;
}

#imageModal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.95);
  justify-content: center;
  align-items: center;
  z-index: 9999;
  cursor: zoom-out;
}

#imageModal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 10px;
  box-shadow: 0 0 50px rgba(0, 255, 65, 0.5);
}

/* Side Panels */
.side-panel {
  position: absolute;
  top: 70px;
  right: 20px;
  background: rgba(10, 14, 39, 0.98);
  border: 2px solid #00ff41;
  border-radius: 10px;
  padding: 20px;
  display: none;
  z-index: 100;
  min-width: 320px;
  max-width: 400px;
  max-height: 70vh;
  overflow-y: auto;
  box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
}

.side-panel::-webkit-scrollbar {
  width: 6px;
}

.side-panel::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.3);
}

.side-panel::-webkit-scrollbar-thumb {
  background: #00ff41;
  border-radius: 3px;
}

.side-panel h3 {
  color: #0ff;
  margin-bottom: 15px;
  border-bottom: 1px solid #00ff41;
  padding-bottom: 10px;
}

.side-panel h4 {
  color: #0ff;
  margin-bottom: 10px;
  font-size: 0.9em;
}

/* Dimension Panel */
.dimension-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px;
  margin-bottom: 8px;
  background: rgba(0, 255, 65, 0.05);
  border: 1px solid #00ff41;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.3s;
}

.dimension-item:hover {
  background: rgba(0, 255, 65, 0.15);
  transform: translateX(5px);
}

.dimension-item.active {
  background: rgba(0, 255, 65, 0.2);
  border-color: #0ff;
  box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
}

.dimension-icon {
  font-size: 1.5em;
}

/* Task Panel */
.task-create {
  margin-bottom: 20px;
}

.task-input {
  margin-bottom: 10px;
}

.task-item {
  background: rgba(0, 255, 65, 0.05);
  border: 1px solid #00ff41;
  border-radius: 5px;
  padding: 12px;
  margin-bottom: 10px;
}

.task-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.task-header strong {
  color: #00ff41;
  font-size: 0.95em;
}

.task-status {
  padding: 3px 8px;
  border-radius: 3px;
  font-size: 0.75em;
  font-weight: bold;
}

.task-status.pending {
  background: rgba(255, 165, 0, 0.3);
  color: #ffa500;
  border: 1px solid #ffa500;
}

.task-status.completed {
  background: rgba(0, 255, 65, 0.3);
  color: #00ff41;
  border: 1px solid #00ff41;
}

.task-desc {
  color: #fff;
  font-size: 0.85em;
  margin-bottom: 8px;
  line-height: 1.4;
}

.task-meta {
  color: #666;
  font-size: 0.75em;
}

.panel-btn {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  font-size: 0.9em;
}

/* Settings Panel */
.settings-panel {
  position: absolute;
  top: 70px;
  right: 20px;
  background: rgba(10, 14, 39, 0.98);
  border: 2px solid #00ff41;
  border-radius: 10px;
  padding: 20px;
  display: none;
  z-index: 100;
  min-width: 300px;
  box-shadow: 0 0 30px rgba(0, 255, 65, 0.3);
}

.settings-panel h3 {
  color: #0ff;
  margin-bottom: 15px;
  border-bottom: 1px solid #00ff41;
  padding-bottom: 10px;
}

.setting-item {
  margin-bottom: 15px;
}

.setting-item label {
  display: block;
  color: #00ff41;
  margin-bottom: 5px;
  font-size: 0.9em;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
}

input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.icon-btn {
  background: transparent;
  border: 1px solid #00ff41;
  color: #00ff41;
  padding: 8px 15px;
  width: auto;
  font-size: 0.9em;
}

.icon-btn:hover {
  background: rgba(0, 255, 65, 0.1);
}

.portal-btn {
  background: linear-gradient(45deg, #ff00ff, #00ffff);
  border: 2px solid #ff00ff;
  color: #fff;
  animation: portalPulse 2s infinite;
}

@keyframes portalPulse {
  0%, 100% { 
    box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
  }
  50% { 
    box-shadow: 0 0 40px rgba(255, 0, 255, 0.8), 0 0 60px rgba(0, 255, 255, 0.6);
  }
}

/* Quantum Dimension */
#quantumDimension {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, #1a0033, #000);
  z-index: 2000;
  flex-direction: column;
  animation: dimensionShift 1s;
}

@keyframes dimensionShift {
  0% { opacity: 0; transform: scale(0.8) rotate(5deg); }
  100% { opacity: 1; transform: scale(1) rotate(0deg); }
}

.quantum-header {
  background: rgba(255, 0, 255, 0.2);
  border-bottom: 2px solid #ff00ff;
  padding: 20px;
  text-align: center;
}

.quantum-header h2 {
  color: #ff00ff;
  font-size: 2em;
  text-shadow: 0 0 20px #ff00ff;
  margin-bottom: 10px;
}

.quantum-content {
  flex: 1;
  overflow-y: auto;
  padding: 30px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.ai-avatar {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  background: linear-gradient(45deg, #ff00ff, #00ffff);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 3em;
  animation: avatarFloat 3s ease-in-out infinite;
  box-shadow: 0 0 40px rgba(255, 0, 255, 0.6);
}

@keyframes avatarFloat {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

.ai-message {
  background: rgba(255, 0, 255, 0.1);
  border: 2px solid #ff00ff;
  border-radius: 15px;
  padding: 20px;
  max-width: 800px;
  color: #fff;
  font-size: 1.1em;
  line-height: 1.6;
  animation: messageAppear 0.5s;
}

@keyframes messageAppear {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.formula-box {
  background: rgba(0, 255, 255, 0.1);
  border: 2px solid #0ff;
  border-radius: 10px;
  padding: 25px;
  margin-top: 20px;
  max-width: 800px;
  width: 100%;
}

.formula-title {
  color: #0ff;
  font-size: 1.3em;
  margin-bottom: 15px;
  text-align: center;
}

.formula-content {
  color: #fff;
  font-size: 1.1em;
  line-height: 1.8;
}

.formula-math {
  background: rgba(0, 0, 0, 0.5);
  padding: 15px;
  border-radius: 5px;
  margin: 15px 0;
  font-family: 'Courier New', monospace;
  color: #00ff41;
  text-align: center;
  font-size: 1.2em;
}

.close-quantum {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(255, 0, 255, 0.3);
  border: 2px solid #ff00ff;
  color: #ff00ff;
  padding: 10px 20px;
  cursor: pointer;
  border-radius: 5px;
  font-size: 1em;
  width: auto;
}

.close-quantum:hover {
  background: rgba(255, 0, 255, 0.5);
  transform: translateY(0);
}

.task-input-area {
  margin-top: 30px;
  width: 100%;
  max-width: 800px;
}

.task-input-area input {
  width: 100%;
  padding: 15px;
  background: rgba(0, 0, 0, 0.7);
  border: 2px solid #ff00ff;
  color: #ff00ff;
  font-family: 'Courier New', monospace;
  font-size: 1em;
  border-radius: 10px;
  margin-bottom: 15px;
}

.task-input-area button {
  width: 100%;
  background: linear-gradient(45deg, #ff00ff, #00ffff);
  color: #fff;
}

/* Responsive */
@media (max-width: 768px) {
  .status-bar {
    font-size: 0.75em;
    gap: 10px;
  }
  
  .icon-btn {
    padding: 6px 10px;
    font-size: 0.8em;
  }
  
  .side-panel {
    right: 10px;
    left: 10px;
    max-width: calc(100% - 20px);
  }
  
  .access-panel {
    min-width: 90%;
    padding: 30px 20px;
  }
  
  .message {
    max-width: 90%;
  }
}</style>
</head>
<body>
  <canvas id="matrix-bg"></canvas>

  <!-- Login Screen -->
  <div id="namePrompt">
    <div class="terminal-header">
      <h1>⚡ CIPHERCHAIN COMMAND ⚡</h1>
      <p>HIERARCHICAL ENCRYPTED NETWORK</p>
    </div>
    <div class="access-panel">
      <div class="input-group">
        <label>👤 CODENAME</label>
        <input type="text" id="inputName" placeholder="shab01 / agent1 / agent2..." />
        <small style="color: #666; margin-top: 5px; display: block;">
          CEO: shab01 | Agents: agent1, agent2, agent3...
        </small>
      </div>
      <div class="input-group">
        <label>🔐 ACCESS KEY (Optional)</label>
        <input type="password" id="inputKey" placeholder="Enter access key..." />
      </div>
      <button onclick="submitName()">⚡ CONNECT TO NETWORK ⚡</button>
    </div>
  </div>

  <!-- Main Chat Interface -->
  <div id="chatInterface">
    <div class="chat-header">
      <h2 id="roomTitle">⚡ CIPHERCHAIN TERMINAL</h2>
      <div class="status-bar">
        <div class="status-indicator">
          <div class="status-dot"></div>
          <span id="connectionStatus">SECURE CONNECTION</span>
        </div>
        <div class="user-info">
          <span id="roleDisplay"></span>
          <span id="userDisplay"></span>
        </div>
        <button class="icon-btn" id="dimensionBtn" onclick="toggleDimensionPanel()">🌀 DIMENSIONS</button>
        <button class="icon-btn portal-btn" onclick="openQuantumDimension()">🔮 QUANTUM AI</button>
        <button class="icon-btn" id="taskBtn" onclick="toggleTaskPanel()">📋 TASKS</button>
        <button class="icon-btn" onclick="toggleSettings()">⚙️ SETTINGS</button>
      </div>
    </div>

    <!-- Dimension/Room Panel -->
    <div class="side-panel" id="dimensionPanel">
      <h3>🌀 DIMENSIONS</h3>
      <div id="dimensionList">
        <div class="dimension-item active" data-room="main-hq" onclick="switchDimension('main-hq')">
          <span class="dimension-icon">🏢</span>
          <span>MAIN HQ</span>
        </div>
      </div>
      <div id="ceoControls" style="display: none;">
        <hr style="border-color: #00ff41; margin: 15px 0;">
        <button class="panel-btn" onclick="createDimension()">➕ CREATE DIMENSION</button>
      </div>
    </div>

    <!-- Task Panel -->
    <div class="side-panel" id="taskPanel">
      <h3>📋 TASK MANAGER</h3>
      
      <!-- CEO Task Assignment -->
      <div id="ceoTaskControls" style="display: none;">
        <div class="task-create">
          <select id="assignTo" class="task-input">
            <option value="">Select Agent...</option>
          </select>
          <input type="text" id="taskTitle" class="task-input" placeholder="Task title..." />
          <textarea id="taskDesc" class="task-input" placeholder="Task description..."></textarea>
          <button class="panel-btn" onclick="assignTask()">🎯 ASSIGN TASK</button>
        </div>
        <hr style="border-color: #00ff41; margin: 15px 0;">
        <h4 style="color: #0ff; margin-bottom: 10px;">ALL AGENT TASKS</h4>
        <div id="allTasksList"></div>
      </div>

      <!-- Agent Task View -->
      <div id="agentTaskView" style="display: none;">
        <h4 style="color: #0ff; margin-bottom: 10px;">MY TASKS</h4>
        <div id="myTasksList"></div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
      <h3>⚙️ TERMINAL SETTINGS</h3>
      <div class="setting-item">
        <label class="checkbox-label">
          <input type="checkbox" id="showTimestamp" checked />
          <span>🕐 Show Timestamps</span>
        </label>
      </div>
      <div class="setting-item">
        <label class="checkbox-label">
          <input type="checkbox" id="soundEffects" />
          <span>🔊 Sound Effects</span>
        </label>
      </div>
      <div class="setting-item">
        <button onclick="clearCurrentRoom()">🗑️ CLEAR ROOM</button>
      </div>
    </div>

    <!-- Messages Area -->
    <div id="messages"></div>

    <!-- Input Area -->
    <div class="input-area">
      <div class="input-controls">
        <input type="text" id="input" placeholder="Type message..." />
        <button onclick="sendMessage()">⚡ SEND</button>
      </div>
      <div class="media-controls">
        <button class="media-button" onclick="document.getElementById('imageInput').click()">📷 IMAGE</button>
        <button class="media-button" onclick="document.getElementById('videoInput').click()">🎥 VIDEO</button>
        <button class="media-button" onclick="shareLocation()">📍 LOCATION</button>
        <button class="media-button" onclick="sendFile()">📁 FILE</button>
      </div>
      <input type="file" id="imageInput" accept="image/*" onchange="sendImage()" />
      <input type="file" id="videoInput" accept="video/*" onchange="sendVideo()" />
    </div>
  </div>

  <!-- Quantum AI Dimension -->
  <div id="quantumDimension">
    <button class="close-quantum" onclick="closeQuantumDimension()">✕ EXIT PORTAL</button>
    <div class="quantum-header">
      <h2>🌌 QUANTUM AI DIMENSION 🌌</h2>
      <p style="color: #0ff;">Reality Calculation & Formula Generation System</p>
    </div>
    <div class="quantum-content">
      <div class="ai-avatar">🤖</div>
      <div class="ai-message" id="aiGreeting"></div>
      <div class="task-input-area">
        <input type="text" id="taskInput" placeholder="Describe your real-world task or problem..." />
        <button onclick="generateFormula()">🔮 GENERATE QUANTUM FORMULA</button>
      </div>
      <div id="formulaDisplay"></div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" onclick="this.style.display='none'">
    <img id="modalImage" src="" />
  </div>

  <script>// Matrix background effect
const canvas = document.getElementById('matrix-bg');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const chars = '01アイウエオカキクケコサシスセソタチツテトナニヌネノ';
const fontSize = 14;
const columns = canvas.width / fontSize;
const drops = Array(Math.floor(columns)).fill(1);

function drawMatrix() {
  ctx.fillStyle = 'rgba(10, 14, 39, 0.05)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#00ff41';
  ctx.font = fontSize + 'px monospace';

  for (let i = 0; i < drops.length; i++) {
    const text = chars[Math.floor(Math.random() * chars.length)];
    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
      drops[i] = 0;
    }
    drops[i]++;
  }
}

setInterval(drawMatrix, 33);

window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

// Global variables
let socket;
let clientId = null;
let myName = '';
let myRole = 'agent'; // 'ceo' or 'agent'
let currentRoom = 'main-hq';
let dimensions = {};

// Role detection
function detectRole(codename) {
  const lower = codename.toLowerCase();
  if (lower === 'shab01') {
    return 'ceo';
  } else if (lower.startsWith('agent')) {
    return 'agent';
  }
  return 'agent'; // default
}

// Initialize dimensions in memory
function initDimensions() {
  dimensions['main-hq'] = [];
  // Load saved dimensions from localStorage
  const saved = localStorage.getItem('cipherchain_dimensions');
  if (saved) {
    const savedDims = JSON.parse(saved);
    Object.assign(dimensions, savedDims);
  }
}

// Save dimensions structure
function saveDimensions() {
  const toSave = {};
  for (let key in dimensions) {
    toSave[key] = []; // Don't save messages, just structure
  }
  localStorage.setItem('cipherchain_dimensions', JSON.stringify(toSave));
}

// Get storage key for current room
function getRoomKey() {
  return `cipherchain_room_${currentRoom}`;
}

// Main initialization
window.onload = function () {
  socket = new WebSocket('wss://groupchat-mfp1.onrender.com');
  initDimensions();

  const imageModal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === 'assign-id') {
      clientId = data.id;
      return;
    }

    // Only show messages for current room
    if (data.room === currentRoom) {
      displayMessage(data);
      saveRoomMessage(data);
    }
  };

  socket.onopen = () => {
    console.log('Connected to server');
  };

  socket.onerror = (error) => {
    console.error('WebSocket error:', error);
  };

  function displayMessage(data) {
    const messages = document.getElementById('messages');
    const msg = document.createElement('div');
    msg.classList.add('message');
    msg.classList.add(data.from === clientId ? 'me' : 'other');

    const header = document.createElement('div');
    header.classList.add('message-header');

    const senderName = data.from === clientId ? 'You' : (data.name || `Agent-${data.from}`);
    const sender = document.createElement('span');
    sender.classList.add('sender-name');
    
    // Add role badge
    let roleBadge = '';
    if (data.role === 'ceo') {
      roleBadge = '👑 CEO ';
    } else {
      roleBadge = '🔧 ';
    }
    sender.textContent = roleBadge + senderName;

    const timestamp = document.createElement('span');
    timestamp.classList.add('timestamp');
    const time = data.timestamp ? new Date(data.timestamp) : new Date();
    timestamp.textContent = time.toLocaleTimeString();
    if (document.getElementById('showTimestamp') && !document.getElementById('showTimestamp').checked) {
      timestamp.style.display = 'none';
    }

    header.appendChild(sender);
    header.appendChild(timestamp);
    msg.appendChild(header);

    const content = document.createElement('div');
    content.classList.add('message-content');

    if (data.image) {
      const img = document.createElement('img');
      img.src = data.image;
      img.addEventListener('click', () => {
        modalImage.src = data.image;
        imageModal.style.display = 'flex';
      });
      content.appendChild(img);
    }

    if (data.video) {
      const video = document.createElement('video');
      video.src = data.video;
      video.controls = true;
      content.appendChild(video);
    }

    if (data.text) {
      const textDiv = document.createElement('div');
      textDiv.textContent = data.text;
      content.appendChild(textDiv);
    }

    msg.appendChild(content);
    messages.appendChild(msg);
    messages.scrollTop = messages.scrollHeight;

    if (document.getElementById('soundEffects') && document.getElementById('soundEffects').checked && data.from !== clientId) {
      playNotificationSound();
    }
  }

  function saveRoomMessage(data) {
    const key = getRoomKey();
    let roomMessages = [];
    const saved = localStorage.getItem(key);
    if (saved) {
      roomMessages = JSON.parse(saved);
    }
    roomMessages.push(data);
    // Keep only last 100 messages per room
    if (roomMessages.length > 100) {
      roomMessages = roomMessages.slice(-100);
    }
    localStorage.setItem(key, JSON.stringify(roomMessages));
  }

  function loadRoomMessages() {
    const key = getRoomKey();
    const saved = localStorage.getItem(key);
    if (saved) {
      const messages = JSON.parse(saved);
      messages.forEach(msg => displayMessage(msg));
    }
  }

  function playNotificationSound() {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    gainNode.gain.value = 0.1;
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.1);
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      imageModal.style.display = 'none';
      document.getElementById('settingsPanel').style.display = 'none';
      document.getElementById('dimensionPanel').style.display = 'none';
      document.getElementById('taskPanel').style.display = 'none';
    }
  });

  document.getElementById('input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  window.submitName = function () {
    const nameInput = document.getElementById('inputName');
    const inputname = nameInput.value.trim();
    if (!inputname) return alert('⚠️ CODENAME REQUIRED');
    
    myName = inputname;
    myRole = detectRole(myName);
    
    socket.send(JSON.stringify({ type: 'set-name', name: myName }));
    document.getElementById('namePrompt').style.display = 'none';
    document.getElementById('chatInterface').style.display = 'flex';
    
    // Update UI based on role
    if (myRole === 'ceo') {
      document.getElementById('roleDisplay').innerHTML = '<span style="color: #ffd700;">👑 CEO</span> | ';
      document.getElementById('ceoControls').style.display = 'block';
      document.getElementById('ceoTaskControls').style.display = 'block';
      populateAgentList();
      loadAllTasks();
    } else {
      document.getElementById('roleDisplay').innerHTML = '<span style="color: #0ff;">🔧 AGENT</span> | ';
      document.getElementById('agentTaskView').style.display = 'block';
      loadMyTasks();
    }
    
    document.getElementById('userDisplay').textContent = `[${myName}]`;
    loadRoomMessages();
  };

  window.sendMessage = function () {
    const input = document.getElementById('input');
    const text = input.value.trim();
    if (!text) return;
    
    const messageData = { 
      type: 'text', 
      text, 
      name: myName,
      role: myRole,
      room: currentRoom
    };
    
    socket.send(JSON.stringify(messageData));
    input.value = '';
  };

  window.sendImage = function () {
    const input = document.getElementById('imageInput');
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      socket.send(JSON.stringify({ 
        type: 'image', 
        image: reader.result, 
        name: myName,
        role: myRole,
        room: currentRoom
      }));
    };
    reader.readAsDataURL(file);
    input.value = '';
  };

  window.sendVideo = function () {
    const input = document.getElementById('videoInput');
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      socket.send(JSON.stringify({ 
        type: 'video', 
        video: reader.result, 
        name: myName,
        role: myRole,
        room: currentRoom
      }));
    };
    reader.readAsDataURL(file);
    input.value = '';
  };

  window.shareLocation = function () {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((position) => {
        const text = `📍 Location: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`;
        socket.send(JSON.stringify({ 
          type: 'text', 
          text, 
          name: myName,
          role: myRole,
          room: currentRoom
        }));
      }, () => {
        alert('⚠️ Location access denied');
      });
    } else {
      alert('⚠️ Geolocation not supported');
    }
  };

  window.sendFile = function () {
    const fileName = prompt('📁 Enter file name to share:');
    if (fileName) {
      const text = `📁 Shared file: ${fileName}`;
      socket.send(JSON.stringify({ 
        type: 'text', 
        text, 
        name: myName,
        role: myRole,
        room: currentRoom
      }));
    }
  };

  window.toggleSettings = function () {
    const panel = document.getElementById('settingsPanel');
    if (panel) {
      const isVisible = panel.style.display === 'block';
      hideAllPanels();
      panel.style.display = isVisible ? 'none' : 'block';
    }
  };

  window.clearCurrentRoom = function () {
    if (confirm(`🗑️ Clear all messages in ${currentRoom.toUpperCase()}?`)) {
      document.getElementById('messages').innerHTML = '';
      localStorage.removeItem(getRoomKey());
    }
  };
};

// Dimension/Room Management
function hideAllPanels() {
  document.getElementById('settingsPanel').style.display = 'none';
  document.getElementById('dimensionPanel').style.display = 'none';
  document.getElementById('taskPanel').style.display = 'none';
}

window.toggleDimensionPanel = function() {
  const panel = document.getElementById('dimensionPanel');
  const isVisible = panel.style.display === 'block';
  hideAllPanels();
  panel.style.display = isVisible ? 'none' : 'block';
};

window.toggleTaskPanel = function() {
  const panel = document.getElementById('taskPanel');
  const isVisible = panel.style.display === 'block';
  hideAllPanels();
  panel.style.display = isVisible ? 'none' : 'block';
};

window.switchDimension = function(roomName) {
  currentRoom = roomName;
  document.getElementById('messages').innerHTML = '';
  document.getElementById('roomTitle').textContent = `⚡ ${roomName.toUpperCase().replace('-', ' ')}`;
  
  // Update active dimension
  document.querySelectorAll('.dimension-item').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelector(`[data-room="${roomName}"]`).classList.add('active');
  
  // Load room messages
  const key = `cipherchain_room_${roomName}`;
  const saved = localStorage.getItem(key);
  if (saved) {
    const messages = JSON.parse(saved);
    messages.forEach(msg => {
      const event = { data: JSON.stringify(msg) };
      // Trigger display without re-saving
      displayMessageDirect(msg);
    });
  }
};

function displayMessageDirect(data) {
  const messages = document.getElementById('messages');
  const msg = document.createElement('div');
  msg.classList.add('message');
  msg.classList.add(data.from === clientId ? 'me' : 'other');

  const header = document.createElement('div');
  header.classList.add('message-header');

  const senderName = data.from === clientId ? 'You' : (data.name || `Agent-${data.from}`);
  const sender = document.createElement('span');
  sender.classList.add('sender-name');
  
  let roleBadge = data.role === 'ceo' ? '👑 CEO ' : '🔧 ';
  sender.textContent = roleBadge + senderName;

  const timestamp = document.createElement('span');
  timestamp.classList.add('timestamp');
  const time = data.timestamp ? new Date(data.timestamp) : new Date();
  timestamp.textContent = time.toLocaleTimeString();

  header.appendChild(sender);
  header.appendChild(timestamp);
  msg.appendChild(header);

  const content = document.createElement('div');
  content.classList.add('message-content');

  if (data.text) {
    const textDiv = document.createElement('div');
    textDiv.textContent = data.text;
    content.appendChild(textDiv);
  }

  msg.appendChild(content);
  messages.appendChild(msg);
  messages.scrollTop = messages.scrollHeight;
}

window.createDimension = function() {
  if (myRole !== 'ceo') return;
  
  const roomName = prompt('🌀 Enter dimension name (e.g., project-alpha):');
  if (!roomName) return;
  
  const cleanName = roomName.toLowerCase().replace(/\s+/g, '-');
  if (dimensions[cleanName]) {
    return alert('⚠️ Dimension already exists!');
  }
  
  dimensions[cleanName] = [];
  saveDimensions();
  
  // Add to UI
  const list = document.getElementById('dimensionList');
  const item = document.createElement('div');
  item.className = 'dimension-item';
  item.setAttribute('data-room', cleanName);
  item.onclick = () => switchDimension(cleanName);
  item.innerHTML = `<span class="dimension-icon">🌐</span><span>${cleanName.toUpperCase().replace('-', ' ')}</span>`;
  list.appendChild(item);
  
  alert(`✅ Dimension "${cleanName}" created!`);
};

// Task Management
function populateAgentList() {
  const select = document.getElementById('assignTo');
  // Add known agents
  for (let i = 1; i <= 10; i++) {
    const option = document.createElement('option');
    option.value = `agent${i}`;
    option.textContent = `Agent ${i}`;
    select.appendChild(option);
  }
}

window.assignTask = function() {
  if (myRole !== 'ceo') return;
  
  const assignTo = document.getElementById('assignTo').value;
  const title = document.getElementById('taskTitle').value.trim();
  const desc = document.getElementById('taskDesc').value.trim();
  
  if (!assignTo || !title) {
    return alert('⚠️ Please select agent and enter task title!');
  }
  
  const task = {
    id: Date.now(),
    assignedTo: assignTo,
    assignedBy: myName,
    title: title,
    description: desc,
    status: 'pending',
    createdAt: new Date().toISOString()
  };
  
  // Save to agent's localStorage key
  const agentKey = `cipherchain_tasks_${assignTo}`;
  let agentTasks = [];
  const saved = localStorage.getItem(agentKey);
  if (saved) {
    agentTasks = JSON.parse(saved);
  }
  agentTasks.push(task);
  localStorage.setItem(agentKey, JSON.stringify(agentTasks));
  
  // Clear inputs
  document.getElementById('taskTitle').value = '';
  document.getElementById('taskDesc').value = '';
  document.getElementById('assignTo').value = '';
  
  alert(`✅ Task assigned to ${assignTo}!`);
  loadAllTasks();
  
  // Notify in chat
  socket.send(JSON.stringify({
    type: 'text',
    text: `📋 NEW TASK ASSIGNED to ${assignTo}: ${title}`,
    name: myName,
    role: myRole,
    room: currentRoom
  }));
};

function loadAllTasks() {
  const container = document.getElementById('allTasksList');
  container.innerHTML = '';
  
  // Load all agent tasks
  for (let i = 1; i <= 10; i++) {
    const agentName = `agent${i}`;
    const key = `cipherchain_tasks_${agentName}`;
    const saved = localStorage.getItem(key);
    if (saved) {
      const tasks = JSON.parse(saved);
      tasks.forEach(task => {
        const taskEl = createTaskElement(task, true);
        container.appendChild(taskEl);
      });
    }
  }
  
  if (container.innerHTML === '') {
    container.innerHTML = '<p style="color: #666;">No tasks assigned yet.</p>';
  }
}

function loadMyTasks() {
  const container = document.getElementById('myTasksList');
  container.innerHTML = '';
  
  const key = `cipherchain_tasks_${myName.toLowerCase()}`;
  const saved = localStorage.getItem(key);
  if (saved) {
    const tasks = JSON.parse(saved);
    tasks.forEach(task => {
      const taskEl = createTaskElement(task, false);
      container.appendChild(taskEl);
    });
  }
  
  if (container.innerHTML === '') {
    container.innerHTML = '<p style="color: #666;">No tasks assigned to you.</p>';
  }
}

function createTaskElement(task, isCEO) {
  const div = document.createElement('div');
  div.className = 'task-item';
  div.innerHTML = `
    <div class="task-header">
      <strong>${task.title}</strong>
      <span class="task-status ${task.status}">${task.status.toUpperCase()}</span>
    </div>
    ${task.description ? `<div class="task-desc">${task.description}</div>` : ''}
    <div class="task-meta">
      ${isCEO ? `👤 ${task.assignedTo} | ` : ''}📅 ${new Date(task.createdAt).toLocaleDateString()}
    </div>
  `;
  return div;
}

// Quantum AI Functions (keeping your original)
window.openQuantumDimension = async function() {
  const quantumDim = document.getElementById('quantumDimension');
  if (!quantumDim) return;
  
  quantumDim.style.display = 'flex';
  
  const now = new Date();
  const phTime = now.toLocaleString('en-US', { timeZone: 'Asia/Manila' });
  const greeting = `
    🌟 Greetings, ${myRole === 'ceo' ? 'CEO' : 'Agent'}! Welcome to the Quantum Dimension! 🌟
    <br><br>
    I am NEXUS-AI, your reality computation assistant. The current time in the Philippines is <strong>${phTime}</strong>.
    <br><br>
    🔮 I can generate practical formulas and algorithms for real-world problems!
    <br><br>
    💡 Simply describe your task or problem, and I'll create a custom formula!
  `;
  
  const aiGreeting = document.getElementById('aiGreeting');
  if (aiGreeting) {
    aiGreeting.innerHTML = greeting;
  }
  
  await speakText(`Hello ${myRole === 'ceo' ? 'CEO' : 'agent'}! Welcome to the Quantum Dimension. The current time in the Philippines is ${phTime}`);
};

window.closeQuantumDimension = function() {
  const quantumDim = document.getElementById('quantumDimension');
  if (quantumDim) {
    quantumDim.style.display = 'none';
  }
  const formulaDisplay = document.getElementById('formulaDisplay');
  if (formulaDisplay) {
    formulaDisplay.innerHTML = '';
  }
};

window.generateFormula = async function() {
  const taskInput = document.getElementById('taskInput');
  if (!taskInput) return;
  
  const task = taskInput.value.trim();
  if (!task) {
    alert('⚠️ Please describe your task or problem!');
    return;
  }

  const formulaDisplay = document.getElementById('formulaDisplay');
  if (formulaDisplay) {
    formulaDisplay.innerHTML = '<div class="ai-message">🔮 Calculating quantum formula...</div>';
  }

  const localFormula = generateLocalFormula(task);
  displayFormulaResult(task, localFormula);
  await speakText("I've generated a quantum formula for your task!");

  taskInput.value = '';
};

function generateLocalFormula(task) {
  const taskLower = task.toLowerCase();
  
  if (taskLower.includes('invest') || taskLower.includes('compound') || taskLower.includes('savings')) {
    return `
      <strong>Formula:</strong> Compound Interest Calculator
      <br><br>
      <div class="formula-math">A = P(1 + r/n)^(nt)</div>
      <br>
      <strong>Variables:</strong><br>
      • A = Final amount • P = Principal • r = Annual rate • n = Compounds/year • t = Years
      <br><br>
      <strong>Example:</strong> ₱10,000 at 5% for 10 years = <strong>₱16,470</strong>
    `;
  }
  
  if (taskLower.includes('gpa') || taskLower.includes('grade')) {
    return `
      <strong>Formula:</strong> GPA Calculator
      <br><br>
      <div class="formula-math">GPA = Σ(Grade × Credits) / Σ(Credits)</div>
      <br>
      <strong>Example:</strong> Math(1.75×3) + English(1.50×3) + Science(2.00×4) / 10 units = <strong>1.73 GPA</strong>
    `;
  }
  
  return `
    <strong>Formula:</strong> Task Priority Score
    <br><br>
    <div class="formula-math">Priority = (Urgency × 3 + Importance × 2) / Effort</div>
    <br>
    <strong>Example:</strong> Urgent(9) + Important(8) / Effort(6) = <strong>7.17 Priority</strong>
  `;
}

function displayFormulaResult(task, formula) {
  const formulaDisplay = document.getElementById('formulaDisplay');
  if (!formulaDisplay) return;
  
  formulaDisplay.innerHTML = `
    <div class="formula-box">
      <div class="formula-title">⚡ QUANTUM FORMULA ⚡</div>
      <div style="color: #ff00ff; margin-bottom: 15px;"><strong>Task:</strong> ${task}</div>
      <div class="formula-content">${formula}</div>
    </div>
  `;
}

async function speakText(text) {
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 1.1;
    utterance.pitch = 1.0;
    utterance.volume = 0.8;
    speechSynthesis.speak(utterance);
  }
}</script>
</body>
</html>
